<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0" />
<title>AURA — AI Chat</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Sora:wght@300;400;500;600&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://unpkg.com/@phosphor-icons/web@2.1.1/src/regular/style.css" />
<style>
/* ═══════════════════════════════════════════════
   ROOT & TOKENS
═══════════════════════════════════════════════ */
:root {
  --bg: #09090B;
  --glass: rgba(255,255,255,0.03);
  --glass-hover: rgba(255,255,255,0.06);
  --glass-strong: rgba(255,255,255,0.07);
  --border: rgba(255,255,255,0.08);
  --border-strong: rgba(255,255,255,0.14);
  --text: #FFFFFF;
  --text-muted: #888893;
  --text-dim: #52525B;
  --accent: #6C8FFF;
  --accent-glow: rgba(108,143,255,0.15);
  --accent-dim: rgba(108,143,255,0.08);
  --user-bubble: rgba(108,143,255,0.10);
  --user-bubble-border: rgba(108,143,255,0.20);
  --danger: rgba(255,80,80,0.8);
  --success: rgba(80,220,130,0.8);
  --radius-sm: 8px;
  --radius: 14px;
  --radius-lg: 20px;
  --radius-pill: 999px;
  --shadow: 0 8px 32px rgba(0,0,0,0.6);
  --shadow-sm: 0 2px 12px rgba(0,0,0,0.4);
  --blur: blur(20px);
  --blur-sm: blur(12px);
  --font: 'Sora', sans-serif;
  --mono: 'JetBrains Mono', monospace;
  --drawer-width: 300px;
  --header-h: 58px;
  --input-zone-h: auto;
  --transition: 0.25s cubic-bezier(0.4,0,0.2,1);
}

*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

html, body {
  height: 100%;
  font-family: var(--font);
  background: var(--bg);
  color: var(--text);
  overflow: hidden;
  -webkit-tap-highlight-color: transparent;
  user-select: none;
}

/* ── SCROLLBAR ── */
::-webkit-scrollbar { width: 4px; }
::-webkit-scrollbar-track { background: transparent; }
::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.08); border-radius: 999px; }

/* ═══════════════════════════════════════════════
   BACKGROUND GLOW
═══════════════════════════════════════════════ */
#bg-glow {
  position: fixed; inset: 0; pointer-events: none; z-index: 0;
  background:
    radial-gradient(ellipse 70% 35% at 50% 105%, rgba(60,80,180,0.12) 0%, transparent 70%),
    radial-gradient(ellipse 40% 20% at 20% 110%, rgba(80,60,160,0.07) 0%, transparent 60%);
}

/* ═══════════════════════════════════════════════
   LAYOUT SHELL
═══════════════════════════════════════════════ */
#app {
  position: fixed; inset: 0; display: flex; flex-direction: column;
  z-index: 1; overflow: hidden;
}

/* ═══════════════════════════════════════════════
   DRAWER OVERLAY
═══════════════════════════════════════════════ */
#drawer-overlay {
  position: fixed; inset: 0; background: rgba(0,0,0,0.5);
  z-index: 50; opacity: 0; pointer-events: none;
  transition: opacity var(--transition);
  backdrop-filter: blur(2px);
}
#drawer-overlay.open { opacity: 1; pointer-events: all; }

/* ── DRAWER ── */
#drawer {
  position: fixed; top: 0; left: 0; bottom: 0;
  width: var(--drawer-width); z-index: 60;
  background: rgba(12,12,16,0.92);
  border-right: 1px solid var(--border);
  backdrop-filter: var(--blur);
  -webkit-backdrop-filter: var(--blur);
  transform: translateX(-100%);
  transition: transform var(--transition);
  display: flex; flex-direction: column;
  padding: 0;
}
#drawer.open { transform: translateX(0); }

.drawer-header {
  padding: 20px 18px 12px;
  border-bottom: 1px solid var(--border);
}
.drawer-logo {
  font-size: 18px; font-weight: 600; letter-spacing: 0.12em;
  color: var(--text); text-transform: uppercase;
  display: flex; align-items: center; gap: 8px;
}
.drawer-logo span.dot {
  width: 6px; height: 6px; border-radius: 50%;
  background: var(--accent); box-shadow: 0 0 8px var(--accent);
  display: inline-block;
}

.new-chat-btn {
  margin: 14px 14px 10px;
  background: var(--accent-dim);
  border: 1px solid rgba(108,143,255,0.25);
  border-radius: var(--radius);
  color: #a0b4ff;
  font-family: var(--font); font-size: 13px; font-weight: 500;
  padding: 11px 16px; cursor: pointer; display: flex; align-items: center;
  gap: 8px; transition: all var(--transition); width: calc(100% - 28px);
  letter-spacing: 0.02em;
}
.new-chat-btn:hover { background: rgba(108,143,255,0.15); border-color: rgba(108,143,255,0.4); color: #c0ccff; }
.new-chat-btn .ph { font-size: 16px; }

.drawer-section-label {
  padding: 6px 18px 4px;
  font-size: 10px; font-weight: 500; letter-spacing: 0.12em;
  color: var(--text-dim); text-transform: uppercase;
}

.drawer-nav {
  flex: 1; overflow-y: auto; padding: 4px 10px;
}
.nav-item {
  display: flex; align-items: center; gap: 10px;
  padding: 10px 10px; border-radius: var(--radius-sm);
  cursor: pointer; color: var(--text-muted); font-size: 13.5px;
  transition: all var(--transition); border: 1px solid transparent;
  margin-bottom: 2px;
}
.nav-item:hover, .nav-item.active {
  background: var(--glass-hover); color: var(--text);
  border-color: var(--border);
}
.nav-item .ph { font-size: 17px; color: var(--text-dim); flex-shrink: 0; }
.nav-item:hover .ph, .nav-item.active .ph { color: var(--accent); }

.chat-history-list { padding: 0 10px; }
.chat-history-item {
  padding: 9px 10px; border-radius: var(--radius-sm);
  cursor: pointer; font-size: 12.5px; color: var(--text-muted);
  display: flex; align-items: center; gap: 8px;
  white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
  transition: all var(--transition); margin-bottom: 2px;
  border: 1px solid transparent;
}
.chat-history-item:hover { background: var(--glass-hover); color: var(--text); border-color: var(--border); }
.chat-history-item .ph { font-size: 14px; flex-shrink: 0; }
.chat-history-item .chi-title { overflow: hidden; text-overflow: ellipsis; flex: 1; }
.chat-history-item .chi-space-tag {
  font-size: 9px; padding: 2px 5px; border-radius: 4px;
  background: var(--accent-dim); color: #a0b4ff; flex-shrink: 0;
  border: 1px solid rgba(108,143,255,0.2);
}
.chi-delete {
  opacity: 0; font-size: 13px; color: var(--text-dim);
  cursor: pointer; padding: 2px; flex-shrink: 0;
  transition: opacity var(--transition), color var(--transition);
}
.chat-history-item:hover .chi-delete { opacity: 1; }
.chi-delete:hover { color: var(--danger); }

.drawer-bottom {
  padding: 12px 10px;
  border-top: 1px solid var(--border);
}
.export-btn {
  display: flex; align-items: center; gap: 10px;
  padding: 10px 10px; border-radius: var(--radius-sm);
  cursor: pointer; color: var(--text-muted); font-size: 13px;
  transition: all var(--transition); border: 1px solid transparent; width: 100%;
  background: none;
}
.export-btn:hover { background: var(--glass-hover); color: var(--text); border-color: var(--border); }
.export-btn .ph { font-size: 17px; color: var(--text-dim); }

/* ═══════════════════════════════════════════════
   HEADER
═══════════════════════════════════════════════ */
#header {
  height: var(--header-h); flex-shrink: 0;
  display: flex; align-items: center; justify-content: space-between;
  padding: 0 14px;
  background: rgba(9,9,11,0.85);
  border-bottom: 1px solid var(--border);
  backdrop-filter: var(--blur-sm);
  -webkit-backdrop-filter: var(--blur-sm);
  position: relative; z-index: 10;
}

.hdr-left, .hdr-right { display: flex; align-items: center; gap: 4px; }
.hdr-center { flex: 1; padding: 0 12px; min-width: 0; }

.hdr-title {
  font-size: 14px; font-weight: 600; letter-spacing: 0.06em;
  white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
  text-align: center;
}
.hdr-subtitle {
  font-size: 10px; color: var(--text-muted); text-align: center;
  letter-spacing: 0.04em; margin-top: 1px;
}

.icon-btn {
  width: 36px; height: 36px; border-radius: var(--radius-sm);
  display: flex; align-items: center; justify-content: center;
  cursor: pointer; color: var(--text-muted);
  transition: all var(--transition); background: none; border: none;
  font-size: 19px; position: relative;
}
.icon-btn:hover { background: var(--glass-hover); color: var(--text); }
.icon-btn.active { color: var(--accent); }

/* API KEY PANEL */
#apikey-panel {
  position: absolute; top: calc(var(--header-h) + 6px); left: 50px;
  background: rgba(14,14,20,0.96);
  border: 1px solid var(--border-strong);
  border-radius: var(--radius);
  backdrop-filter: var(--blur);
  -webkit-backdrop-filter: var(--blur);
  padding: 14px; z-index: 20;
  min-width: 280px; max-width: calc(100vw - 24px);
  box-shadow: var(--shadow);
  transform: translateY(-8px); opacity: 0; pointer-events: none;
  transition: all var(--transition);
}
#apikey-panel.open { transform: translateY(0); opacity: 1; pointer-events: all; }
#apikey-panel label { font-size: 11px; color: var(--text-muted); letter-spacing: 0.06em; text-transform: uppercase; display: block; margin-bottom: 8px; }
.apikey-row { display: flex; gap: 8px; }
#apikey-input {
  flex: 1; background: rgba(255,255,255,0.04); border: 1px solid var(--border);
  border-radius: var(--radius-sm); padding: 9px 12px;
  color: var(--text); font-family: var(--mono); font-size: 12px;
  outline: none; transition: border-color var(--transition);
}
#apikey-input:focus { border-color: var(--accent); }
#apikey-save {
  background: var(--accent); border: none; border-radius: var(--radius-sm);
  padding: 9px 14px; color: #fff; font-family: var(--font);
  font-size: 12px; font-weight: 500; cursor: pointer;
  transition: opacity var(--transition);
}
#apikey-save:hover { opacity: 0.85; }
#apikey-status { font-size: 11px; color: var(--success); margin-top: 6px; min-height: 14px; }

/* ═══════════════════════════════════════════════
   CHAT ARENA
═══════════════════════════════════════════════ */
#chat-arena {
  flex: 1; overflow-y: auto; padding: 16px 14px 8px;
  scroll-behavior: smooth; position: relative;
}

/* EMPTY STATE */
#empty-state {
  display: flex; flex-direction: column; align-items: center;
  justify-content: center; height: 100%; gap: 16px;
  text-align: center; padding: 24px;
}
.empty-icon { font-size: 40px; color: var(--text-dim); margin-bottom: 4px; }
.empty-title { font-size: 22px; font-weight: 600; letter-spacing: -0.02em; }
.empty-sub { font-size: 13px; color: var(--text-muted); line-height: 1.6; max-width: 260px; }
.starter-chips { display: flex; flex-wrap: wrap; gap: 8px; justify-content: center; margin-top: 8px; }
.chip {
  background: var(--glass-strong); border: 1px solid var(--border);
  border-radius: var(--radius-pill); padding: 7px 14px;
  font-size: 12px; color: var(--text-muted); cursor: pointer;
  transition: all var(--transition);
}
.chip:hover { background: var(--glass-hover); color: var(--text); border-color: var(--border-strong); }

/* MESSAGES */
.msg-group { margin-bottom: 20px; display: flex; flex-direction: column; }
.msg-group.user { align-items: flex-end; }
.msg-group.assistant { align-items: flex-start; }

.msg-avatar {
  width: 26px; height: 26px; border-radius: 50%;
  display: flex; align-items: center; justify-content: center;
  font-size: 12px; font-weight: 600; margin-bottom: 6px;
  flex-shrink: 0;
}
.msg-avatar.ai { background: rgba(108,143,255,0.12); color: var(--accent); border: 1px solid rgba(108,143,255,0.2); }
.msg-avatar.user-av { background: rgba(255,255,255,0.06); color: var(--text-muted); border: 1px solid var(--border); }

.msg-bubble {
  max-width: 85%; padding: 11px 14px; border-radius: var(--radius);
  font-size: 14px; line-height: 1.65; position: relative;
}
.msg-group.user .msg-bubble {
  background: var(--user-bubble);
  border: 1px solid var(--user-bubble-border);
  border-bottom-right-radius: 4px;
}
.msg-group.assistant .msg-bubble {
  background: transparent; padding: 4px 0;
  color: rgba(255,255,255,0.88); max-width: 95%;
}

.msg-image-thumb {
  width: 180px; max-height: 200px; border-radius: var(--radius-sm);
  object-fit: cover; margin-bottom: 8px; display: block;
  border: 1px solid var(--border);
}

.msg-time {
  font-size: 10px; color: var(--text-dim);
  margin-top: 5px; padding: 0 2px;
}

/* CODE BLOCKS */
.code-wrapper {
  background: rgba(0,0,0,0.4); border: 1px solid var(--border);
  border-radius: var(--radius-sm); margin: 10px 0; overflow: hidden;
}
.code-header {
  display: flex; align-items: center; justify-content: space-between;
  padding: 7px 12px; border-bottom: 1px solid var(--border);
  background: rgba(255,255,255,0.02);
}
.code-lang { font-size: 10px; color: var(--text-dim); font-family: var(--mono); letter-spacing: 0.06em; text-transform: uppercase; }
.code-actions { display: flex; gap: 6px; }
.code-action-btn {
  background: none; border: 1px solid var(--border); border-radius: 5px;
  padding: 3px 8px; font-size: 10px; color: var(--text-muted);
  cursor: pointer; font-family: var(--font); transition: all var(--transition);
  display: flex; align-items: center; gap: 4px;
}
.code-action-btn:hover { background: var(--glass-hover); color: var(--text); border-color: var(--border-strong); }
.code-action-btn .ph { font-size: 12px; }
pre { margin: 0; padding: 14px; overflow-x: auto; }
pre code { font-family: var(--mono); font-size: 12.5px; line-height: 1.7; color: #c9d1d9; }

/* Inline code */
p code, li code {
  font-family: var(--mono); font-size: 12px; background: rgba(255,255,255,0.07);
  border: 1px solid var(--border); border-radius: 4px; padding: 1px 5px;
  color: #a0b4ff;
}

/* Markdown styles */
.msg-bubble h1, .msg-bubble h2, .msg-bubble h3 { font-weight: 600; margin: 12px 0 6px; }
.msg-bubble h1 { font-size: 18px; } .msg-bubble h2 { font-size: 16px; } .msg-bubble h3 { font-size: 14px; }
.msg-bubble p { margin-bottom: 8px; }
.msg-bubble ul, .msg-bubble ol { padding-left: 20px; margin-bottom: 8px; }
.msg-bubble li { margin-bottom: 4px; }
.msg-bubble a { color: var(--accent); text-decoration: none; }
.msg-bubble a:hover { text-decoration: underline; }
.msg-bubble strong { font-weight: 600; color: #e0e0ff; }
.msg-bubble em { color: rgba(255,255,255,0.75); font-style: italic; }
.msg-bubble blockquote {
  border-left: 2px solid var(--accent); padding-left: 12px;
  margin: 8px 0; color: var(--text-muted); font-style: italic;
}
.msg-bubble table { width: 100%; border-collapse: collapse; font-size: 13px; margin: 10px 0; }
.msg-bubble th, .msg-bubble td { border: 1px solid var(--border); padding: 6px 10px; }
.msg-bubble th { background: rgba(255,255,255,0.04); font-weight: 500; }
.msg-bubble hr { border: none; border-top: 1px solid var(--border); margin: 12px 0; }

/* TYPING INDICATOR */
.typing-indicator { display: flex; align-items: center; gap: 5px; padding: 4px 0; }
.typing-dot {
  width: 6px; height: 6px; border-radius: 50%;
  background: var(--text-dim); animation: pulse 1.2s ease infinite;
}
.typing-dot:nth-child(2) { animation-delay: 0.2s; }
.typing-dot:nth-child(3) { animation-delay: 0.4s; }
@keyframes pulse {
  0%, 60%, 100% { opacity: 0.3; transform: scale(0.8); }
  30% { opacity: 1; transform: scale(1); }
}

/* ═══════════════════════════════════════════════
   INPUT ZONE
═══════════════════════════════════════════════ */
#input-zone {
  flex-shrink: 0;
  padding: 10px 12px 14px;
  background: rgba(9,9,11,0.9);
  border-top: 1px solid var(--border);
  backdrop-filter: var(--blur-sm);
  -webkit-backdrop-filter: var(--blur-sm);
}

/* IMAGE PREVIEW */
#image-preview-area {
  display: none; align-items: center; gap: 8px;
  margin-bottom: 8px; padding: 8px 10px;
  background: var(--glass); border: 1px solid var(--border);
  border-radius: var(--radius-sm);
}
#image-preview-area.visible { display: flex; }
#img-thumb { width: 44px; height: 44px; border-radius: 7px; object-fit: cover; border: 1px solid var(--border); }
#img-name { font-size: 12px; color: var(--text-muted); flex: 1; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
#img-remove { background: none; border: none; color: var(--text-dim); cursor: pointer; font-size: 16px; padding: 2px; transition: color var(--transition); }
#img-remove:hover { color: var(--danger); }

/* INPUT ROW */
.input-row {
  display: flex; align-items: flex-end; gap: 8px;
}
.input-pill {
  flex: 1; display: flex; align-items: flex-end;
  background: var(--glass-strong);
  border: 1px solid var(--border-strong);
  border-radius: var(--radius-lg);
  padding: 8px 8px 8px 14px;
  transition: border-color var(--transition);
  gap: 6px;
}
.input-pill:focus-within { border-color: rgba(108,143,255,0.35); }

#msg-input {
  flex: 1; background: none; border: none; outline: none;
  color: var(--text); font-family: var(--font); font-size: 14px;
  line-height: 1.5; resize: none; min-height: 22px; max-height: 140px;
  overflow-y: auto; padding: 2px 0; user-select: text;
}
#msg-input::placeholder { color: var(--text-dim); }

.pill-actions { display: flex; align-items: flex-end; gap: 2px; }
.pill-btn {
  width: 32px; height: 32px; border-radius: 50%; display: flex;
  align-items: center; justify-content: center; cursor: pointer;
  color: var(--text-muted); transition: all var(--transition);
  background: none; border: none; font-size: 17px;
}
.pill-btn:hover { color: var(--text); background: rgba(255,255,255,0.06); }
.pill-btn.active { color: var(--accent); }

.side-btn {
  width: 42px; height: 42px; border-radius: 50%;
  display: flex; align-items: center; justify-content: center;
  cursor: pointer; font-size: 18px; flex-shrink: 0;
  transition: all var(--transition); background: none; border: none;
  color: var(--text-muted);
}
.side-btn:hover { color: var(--text); background: var(--glass-hover); }

#send-btn {
  width: 42px; height: 42px; border-radius: 50%;
  background: var(--accent); border: none; cursor: pointer;
  display: flex; align-items: center; justify-content: center;
  color: #fff; font-size: 17px; flex-shrink: 0;
  transition: all var(--transition); box-shadow: 0 0 0 0 rgba(108,143,255,0.4);
}
#send-btn:hover { box-shadow: 0 0 0 6px rgba(108,143,255,0.15); opacity: 0.9; }
#send-btn:active { transform: scale(0.93); }
#send-btn:disabled { opacity: 0.35; cursor: not-allowed; }

/* ═══════════════════════════════════════════════
   MODALS
═══════════════════════════════════════════════ */
.modal-backdrop {
  position: fixed; inset: 0; background: rgba(0,0,0,0.7);
  z-index: 80; display: flex; align-items: flex-end; justify-content: center;
  opacity: 0; pointer-events: none; transition: opacity var(--transition);
  backdrop-filter: blur(4px);
}
.modal-backdrop.open { opacity: 1; pointer-events: all; }

.modal {
  width: 100%; max-width: 520px;
  background: rgba(14,14,20,0.97);
  border: 1px solid var(--border-strong);
  border-radius: var(--radius-lg) var(--radius-lg) 0 0;
  backdrop-filter: var(--blur);
  -webkit-backdrop-filter: var(--blur);
  box-shadow: var(--shadow);
  transform: translateY(20px);
  transition: transform var(--transition);
  max-height: 85vh; display: flex; flex-direction: column;
}
.modal-backdrop.open .modal { transform: translateY(0); }

.modal-drag { width: 36px; height: 4px; border-radius: 2px; background: rgba(255,255,255,0.12); margin: 12px auto 4px; flex-shrink: 0; }

.modal-header {
  display: flex; align-items: center; justify-content: space-between;
  padding: 12px 18px 12px; border-bottom: 1px solid var(--border);
  flex-shrink: 0;
}
.modal-title { font-size: 15px; font-weight: 600; display: flex; align-items: center; gap: 8px; }
.modal-title .ph { font-size: 18px; color: var(--accent); }
.modal-close { background: none; border: none; color: var(--text-muted); font-size: 20px; cursor: pointer; padding: 2px; transition: color var(--transition); }
.modal-close:hover { color: var(--text); }

.modal-body { padding: 16px 18px; overflow-y: auto; flex: 1; }
.modal-footer { padding: 12px 18px 20px; border-top: 1px solid var(--border); flex-shrink: 0; display: flex; gap: 10px; }

/* FORM ELEMENTS */
.form-group { margin-bottom: 14px; }
.form-label { font-size: 11px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.08em; margin-bottom: 7px; display: block; }
.form-input, .form-textarea, .form-select {
  width: 100%; background: rgba(255,255,255,0.04);
  border: 1px solid var(--border); border-radius: var(--radius-sm);
  padding: 10px 12px; color: var(--text);
  font-family: var(--font); font-size: 13.5px; outline: none;
  transition: border-color var(--transition);
}
.form-input:focus, .form-textarea:focus, .form-select:focus { border-color: rgba(108,143,255,0.4); }
.form-textarea { resize: none; min-height: 80px; line-height: 1.5; }
.form-select { appearance: none; cursor: pointer; }
.form-select option { background: #0e0e14; }

.btn-primary {
  flex: 1; background: var(--accent); border: none; border-radius: var(--radius-sm);
  padding: 11px; color: #fff; font-family: var(--font); font-size: 13px;
  font-weight: 500; cursor: pointer; transition: opacity var(--transition);
}
.btn-primary:hover { opacity: 0.85; }
.btn-secondary {
  flex: 1; background: var(--glass-strong); border: 1px solid var(--border);
  border-radius: var(--radius-sm); padding: 11px; color: var(--text-muted);
  font-family: var(--font); font-size: 13px; font-weight: 500; cursor: pointer;
  transition: all var(--transition);
}
.btn-secondary:hover { background: var(--glass-hover); color: var(--text); }
.btn-danger {
  flex: 1; background: rgba(255,80,80,0.1); border: 1px solid rgba(255,80,80,0.25);
  border-radius: var(--radius-sm); padding: 11px; color: rgba(255,120,120,0.9);
  font-family: var(--font); font-size: 13px; font-weight: 500; cursor: pointer;
  transition: all var(--transition);
}
.btn-danger:hover { background: rgba(255,80,80,0.18); }

/* ITEM CARDS */
.item-card {
  background: var(--glass); border: 1px solid var(--border);
  border-radius: var(--radius-sm); padding: 12px 14px;
  margin-bottom: 10px; display: flex; align-items: flex-start;
  gap: 10px; cursor: pointer; transition: all var(--transition);
}
.item-card:hover { background: var(--glass-hover); border-color: var(--border-strong); }
.item-card.selected { border-color: rgba(108,143,255,0.45); background: var(--accent-dim); }
.item-card-icon { width: 34px; height: 34px; border-radius: 8px; background: var(--accent-dim); display: flex; align-items: center; justify-content: center; font-size: 16px; color: var(--accent); flex-shrink: 0; border: 1px solid rgba(108,143,255,0.2); }
.item-card-body { flex: 1; min-width: 0; }
.item-card-title { font-size: 13px; font-weight: 500; margin-bottom: 3px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.item-card-sub { font-size: 11.5px; color: var(--text-muted); overflow: hidden; text-overflow: ellipsis; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; }
.item-card-actions { display: flex; gap: 6px; }
.item-action { background: none; border: 1px solid var(--border); border-radius: 5px; padding: 4px 8px; font-size: 11px; color: var(--text-muted); cursor: pointer; transition: all var(--transition); font-family: var(--font); }
.item-action:hover { border-color: var(--border-strong); color: var(--text); }
.item-action.del:hover { color: var(--danger); border-color: rgba(255,80,80,0.3); }

.empty-list { text-align: center; padding: 30px 0; color: var(--text-dim); font-size: 13px; }
.empty-list .ph { font-size: 28px; display: block; margin-bottom: 8px; }

/* ═══════════════════════════════════════════════
   CANVAS OVERLAY
═══════════════════════════════════════════════ */
#canvas-overlay {
  position: fixed; inset: 0; z-index: 100;
  background: rgba(0,0,0,0.95);
  display: flex; flex-direction: column;
  transform: translateY(100%); transition: transform 0.35s cubic-bezier(0.4,0,0.2,1);
}
#canvas-overlay.open { transform: translateY(0); }

#canvas-toolbar {
  display: flex; align-items: center; gap: 10px;
  padding: 10px 14px; border-bottom: 1px solid var(--border);
  background: rgba(12,12,16,0.98); flex-shrink: 0;
}
#canvas-title { flex: 1; font-size: 13px; font-weight: 500; color: var(--text-muted); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; font-family: var(--mono); }
.canvas-tab {
  padding: 6px 14px; border-radius: 6px; font-size: 12px;
  cursor: pointer; transition: all var(--transition); border: 1px solid transparent;
  color: var(--text-muted); background: none; font-family: var(--font);
}
.canvas-tab.active { background: var(--accent-dim); color: #a0b4ff; border-color: rgba(108,143,255,0.25); }

#canvas-content { flex: 1; overflow: hidden; position: relative; }
#canvas-code-view { position: absolute; inset: 0; overflow: auto; padding: 16px; }
#canvas-code-view pre { background: none; padding: 0; }
#canvas-preview { position: absolute; inset: 0; display: none; }
#canvas-preview iframe { width: 100%; height: 100%; border: none; background: #fff; }
#canvas-text-view { position: absolute; inset: 0; overflow: auto; padding: 20px; font-size: 14px; line-height: 1.75; color: rgba(255,255,255,0.85); }

/* ═══════════════════════════════════════════════
   ARTIFACTS GALLERY
═══════════════════════════════════════════════ */
.artifact-thumb {
  background: var(--glass); border: 1px solid var(--border);
  border-radius: var(--radius); padding: 14px;
  margin-bottom: 12px; cursor: pointer; transition: all var(--transition);
}
.artifact-thumb:hover { background: var(--glass-hover); border-color: var(--border-strong); }
.artifact-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 10px; }
.artifact-lang { font-size: 10px; font-family: var(--mono); color: var(--accent); text-transform: uppercase; letter-spacing: 0.08em; }
.artifact-date { font-size: 10px; color: var(--text-dim); }
.artifact-preview {
  font-family: var(--mono); font-size: 11px; color: var(--text-muted);
  overflow: hidden; max-height: 60px; white-space: pre-wrap; word-break: break-all;
  opacity: 0.7; line-height: 1.5;
}

/* SPACES */
.space-chip {
  display: inline-flex; align-items: center; gap: 5px;
  background: var(--accent-dim); border: 1px solid rgba(108,143,255,0.2);
  border-radius: var(--radius-pill); padding: 5px 11px;
  font-size: 12px; color: #a0b4ff; cursor: pointer;
  transition: all var(--transition); margin: 4px;
}
.space-chip.selected { background: rgba(108,143,255,0.2); border-color: rgba(108,143,255,0.5); }

/* PROMPT VAULT */
.vault-item {
  background: var(--glass); border: 1px solid var(--border);
  border-radius: var(--radius-sm); padding: 12px 14px;
  margin-bottom: 8px; display: flex; align-items: flex-start;
  gap: 10px; cursor: pointer; transition: all var(--transition);
}
.vault-item:hover { background: var(--glass-hover); border-color: var(--border-strong); }
.vault-item-content { flex: 1; min-width: 0; }
.vault-item-title { font-size: 13px; font-weight: 500; margin-bottom: 3px; }
.vault-item-text { font-size: 12px; color: var(--text-muted); overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
.vault-item-actions { display: flex; gap: 4px; align-items: center; }

/* ═══════════════════════════════════════════════
   TOASTS
═══════════════════════════════════════════════ */
#toast-container {
  position: fixed; top: 70px; right: 12px; z-index: 200;
  display: flex; flex-direction: column; gap: 8px; pointer-events: none;
}
.toast {
  background: rgba(20,20,28,0.96); border: 1px solid var(--border-strong);
  border-radius: var(--radius-sm); padding: 10px 14px;
  font-size: 13px; color: var(--text);
  backdrop-filter: var(--blur-sm);
  box-shadow: var(--shadow-sm);
  transform: translateX(20px); opacity: 0;
  animation: toast-in 0.25s var(--transition) forwards, toast-out 0.25s 2.5s forwards;
  display: flex; align-items: center; gap: 8px;
}
.toast .ph { font-size: 16px; }
.toast.success { border-color: rgba(80,220,130,0.3); }
.toast.success .ph { color: var(--success); }
.toast.error { border-color: rgba(255,80,80,0.3); }
.toast.error .ph { color: var(--danger); }
@keyframes toast-in { to { transform: translateX(0); opacity: 1; } }
@keyframes toast-out { to { transform: translateX(20px); opacity: 0; } }

/* ═══════════════════════════════════════════════
   MIC INDICATOR
═══════════════════════════════════════════════ */
#mic-indicator {
  position: fixed; bottom: 90px; left: 50%; transform: translateX(-50%);
  background: rgba(20,20,28,0.96); border: 1px solid rgba(255,80,80,0.3);
  border-radius: var(--radius-pill); padding: 8px 16px;
  font-size: 12px; color: rgba(255,120,120,0.9); z-index: 30;
  display: none; align-items: center; gap: 8px;
  backdrop-filter: var(--blur-sm); box-shadow: var(--shadow-sm);
}
#mic-indicator.active { display: flex; }
.mic-pulse { width: 8px; height: 8px; border-radius: 50%; background: rgba(255,80,80,0.9); animation: mic-pulse 1s ease infinite; }
@keyframes mic-pulse { 0%,100% { transform: scale(1); opacity: 1; } 50% { transform: scale(1.4); opacity: 0.6; } }

/* ═══════════════════════════════════════════════
   RESPONSIVE
═══════════════════════════════════════════════ */
@media (min-width: 600px) {
  .modal { border-radius: var(--radius-lg); margin: auto; max-width: 480px; }
  .modal-backdrop { align-items: center; }
}

/* ═══════════════════════════════════════════════
   UTILITY
═══════════════════════════════════════════════ */
.hidden { display: none !important; }
.divider { height: 1px; background: var(--border); margin: 8px 0; }
</style>
</head>
<body>
<div id="bg-glow"></div>

<!-- ═══════════════ DRAWER OVERLAY ═══════════════ -->
<div id="drawer-overlay"></div>

<!-- ═══════════════ DRAWER ═══════════════ -->
<div id="drawer">
  <div class="drawer-header">
    <div class="drawer-logo"><span class="dot"></span>AURA</div>
  </div>

  <button class="new-chat-btn" id="new-chat-btn">
    <i class="ph ph-plus-circle"></i> New Chat
  </button>

  <div class="drawer-nav">
    <div class="drawer-section-label">Navigation</div>
    <div class="nav-item" data-modal="chats"><i class="ph ph-chat-dots"></i> Chats</div>
    <div class="nav-item" data-modal="spaces"><i class="ph ph-folder-open"></i> Spaces</div>
    <div class="nav-item" data-modal="artifacts"><i class="ph ph-atom"></i> Artifacts</div>
    <div class="nav-item" data-modal="personas"><i class="ph ph-mask-happy"></i> Personas</div>
    <div class="nav-item" data-modal="vault"><i class="ph ph-lightning"></i> Prompt Vault</div>

    <div class="divider" style="margin: 12px 0;"></div>
    <div class="drawer-section-label">Recent Chats</div>
    <div id="chat-history-list" class="chat-history-list"></div>
  </div>

  <div class="drawer-bottom">
    <button class="export-btn" id="export-btn">
      <i class="ph ph-download-simple"></i> Export Backup
    </button>
  </div>
</div>

<!-- ═══════════════ MAIN APP ═══════════════ -->
<div id="app">

  <!-- HEADER -->
  <div id="header">
    <div class="hdr-left">
      <button class="icon-btn" id="hamburger-btn" title="Menu"><i class="ph ph-list"></i></button>
      <div style="position:relative;">
        <button class="icon-btn" id="apikey-btn" title="API Key"><i class="ph ph-lock-key"></i></button>
        <!-- API KEY PANEL -->
        <div id="apikey-panel">
          <label>API Key</label>
          <div class="apikey-row">
            <input type="password" id="apikey-input" placeholder="Paste your API key…" autocomplete="off" />
            <button id="apikey-save">Save</button>
          </div>
          <div id="apikey-status"></div>
        </div>
      </div>
    </div>

    <div class="hdr-center">
      <div class="hdr-title" id="hdr-title">New Chat</div>
      <div class="hdr-subtitle" id="hdr-subtitle">AURA AI</div>
    </div>

    <div class="hdr-right">
      <button class="icon-btn" id="clear-btn" title="Clear Chat"><i class="ph ph-trash"></i></button>
    </div>
  </div>

  <!-- CHAT ARENA -->
  <div id="chat-arena">
    <div id="empty-state">
      <div class="empty-icon"><i class="ph ph-sparkle"></i></div>
      <div class="empty-title">How can I help?</div>
      <div class="empty-sub">Ask me anything — code, writing, analysis, or creative ideas.</div>
      <div class="starter-chips">
        <div class="chip" data-prompt="Write a Python function to sort a list of dicts">Python snippet</div>
        <div class="chip" data-prompt="Explain quantum entanglement simply">Explain a concept</div>
        <div class="chip" data-prompt="Draft a professional email declining a meeting">Draft an email</div>
        <div class="chip" data-prompt="Give me 5 startup ideas in the AI space">Startup ideas</div>
      </div>
    </div>
    <div id="messages-container"></div>
  </div>

  <!-- INPUT ZONE -->
  <div id="input-zone">
    <!-- Image preview -->
    <div id="image-preview-area">
      <img id="img-thumb" src="" alt="Preview" />
      <span id="img-name"></span>
      <button id="img-remove"><i class="ph ph-x-circle"></i></button>
    </div>

    <div class="input-row">
      <button class="side-btn" id="camera-btn" title="Attach Image">
        <i class="ph ph-image"></i>
      </button>
      <input type="file" id="file-input" accept="image/*" style="display:none;" />

      <div class="input-pill">
        <textarea id="msg-input" placeholder="Message…" rows="1"></textarea>
        <div class="pill-actions">
          <button class="pill-btn" id="mic-btn" title="Voice Input"><i class="ph ph-microphone"></i></button>
        </div>
      </div>

      <button id="send-btn" title="Send">
        <i class="ph ph-paper-plane-tilt"></i>
      </button>
    </div>
  </div>

</div><!-- /#app -->

<!-- ═══════════════ CANVAS OVERLAY ═══════════════ -->
<div id="canvas-overlay">
  <div id="canvas-toolbar">
    <button class="icon-btn" id="canvas-close-btn"><i class="ph ph-x"></i></button>
    <div id="canvas-title">canvas</div>
    <button class="canvas-tab active" data-view="code">Code</button>
    <button class="canvas-tab" data-view="preview">Preview</button>
    <button class="canvas-tab" data-view="text">Text</button>
    <button class="icon-btn" id="canvas-copy-btn" title="Copy"><i class="ph ph-copy"></i></button>
  </div>
  <div id="canvas-content">
    <div id="canvas-code-view"><pre><code id="canvas-code-el"></code></pre></div>
    <div id="canvas-preview"><iframe id="canvas-iframe" sandbox="allow-scripts allow-same-origin"></iframe></div>
    <div id="canvas-text-view" id="canvas-text-el"></div>
  </div>
</div>

<!-- ═══════════════ MODALS ═══════════════ -->

<!-- PERSONAS MODAL -->
<div class="modal-backdrop" id="personas-modal">
  <div class="modal">
    <div class="modal-drag"></div>
    <div class="modal-header">
      <div class="modal-title"><i class="ph ph-mask-happy"></i> Personas</div>
      <button class="modal-close" data-close="personas-modal"><i class="ph ph-x"></i></button>
    </div>
    <div class="modal-body">
      <div class="form-group">
        <label class="form-label">Name</label>
        <input class="form-input" id="persona-name" placeholder="e.g. Concise, Socratic…" />
      </div>
      <div class="form-group">
        <label class="form-label">System Prompt</label>
        <textarea class="form-textarea" id="persona-prompt" placeholder="You are a concise assistant. Reply in 3 sentences max."></textarea>
      </div>
      <div class="divider"></div>
      <div id="personas-list"></div>
    </div>
    <div class="modal-footer">
      <button class="btn-secondary" data-close="personas-modal">Cancel</button>
      <button class="btn-primary" id="save-persona-btn">Save Persona</button>
    </div>
  </div>
</div>

<!-- SPACES MODAL -->
<div class="modal-backdrop" id="spaces-modal">
  <div class="modal">
    <div class="modal-drag"></div>
    <div class="modal-header">
      <div class="modal-title"><i class="ph ph-folder-open"></i> Spaces</div>
      <button class="modal-close" data-close="spaces-modal"><i class="ph ph-x"></i></button>
    </div>
    <div class="modal-body">
      <div class="form-group">
        <label class="form-label">Create Space</label>
        <div style="display:flex; gap:8px;">
          <input class="form-input" id="space-name" placeholder="e.g. Work, Research…" style="flex:1;" />
          <button class="btn-primary" id="save-space-btn" style="flex:none;padding:10px 16px;">Add</button>
        </div>
      </div>
      <div class="divider"></div>
      <div id="spaces-list"></div>
      <div class="divider" style="margin-top:14px;"></div>
      <div class="form-group" style="margin-bottom:0;">
        <label class="form-label">Assign current chat to space</label>
        <div id="assign-spaces-list"></div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn-primary" data-close="spaces-modal">Done</button>
    </div>
  </div>
</div>

<!-- ARTIFACTS MODAL -->
<div class="modal-backdrop" id="artifacts-modal">
  <div class="modal">
    <div class="modal-drag"></div>
    <div class="modal-header">
      <div class="modal-title"><i class="ph ph-atom"></i> Artifacts</div>
      <button class="modal-close" data-close="artifacts-modal"><i class="ph ph-x"></i></button>
    </div>
    <div class="modal-body">
      <div id="artifacts-list"></div>
    </div>
  </div>
</div>

<!-- PROMPT VAULT MODAL -->
<div class="modal-backdrop" id="vault-modal">
  <div class="modal">
    <div class="modal-drag"></div>
    <div class="modal-header">
      <div class="modal-title"><i class="ph ph-lightning"></i> Prompt Vault</div>
      <button class="modal-close" data-close="vault-modal"><i class="ph ph-x"></i></button>
    </div>
    <div class="modal-body">
      <div class="form-group">
        <label class="form-label">Snippet Title</label>
        <input class="form-input" id="vault-title" placeholder="e.g. Debug this code…" />
      </div>
      <div class="form-group">
        <label class="form-label">Prompt Text</label>
        <textarea class="form-textarea" id="vault-text" placeholder="Paste your reusable prompt…"></textarea>
      </div>
      <div class="divider"></div>
      <div id="vault-list"></div>
    </div>
    <div class="modal-footer">
      <button class="btn-secondary" data-close="vault-modal">Cancel</button>
      <button class="btn-primary" id="save-vault-btn">Save Snippet</button>
    </div>
  </div>
</div>

<!-- CONFIRM MODAL -->
<div class="modal-backdrop" id="confirm-modal">
  <div class="modal">
    <div class="modal-drag"></div>
    <div class="modal-header">
      <div class="modal-title" id="confirm-title">Confirm</div>
      <button class="modal-close" data-close="confirm-modal"><i class="ph ph-x"></i></button>
    </div>
    <div class="modal-body">
      <p id="confirm-message" style="font-size:14px; color:var(--text-muted); line-height:1.6;"></p>
    </div>
    <div class="modal-footer">
      <button class="btn-secondary" data-close="confirm-modal">Cancel</button>
      <button class="btn-danger" id="confirm-ok-btn">Confirm</button>
    </div>
  </div>
</div>

<!-- TOAST CONTAINER -->
<div id="toast-container"></div>
<!-- MIC INDICATOR -->
<div id="mic-indicator"><div class="mic-pulse"></div> Listening…</div>

<!-- ═══════════════════════════════════════════════
     JAVASCRIPT
═══════════════════════════════════════════════ -->
<script>
/* ═══════════════════════════════════════════════
   STORAGE UTILS
═══════════════════════════════════════════════ */
const LS = {
  get: (k, def = null) => { try { const v = localStorage.getItem(k); return v ? JSON.parse(v) : def; } catch { return def; } },
  set: (k, v) => { try { localStorage.setItem(k, JSON.stringify(v)); } catch(e) { console.warn('LS write fail', e); } },
  remove: (k) => localStorage.removeItem(k),
  all: () => { const r = {}; for (let i=0; i<localStorage.length; i++) { const k = localStorage.key(i); try { r[k] = JSON.parse(localStorage.getItem(k)); } catch { r[k] = localStorage.getItem(k); } } return r; }
};

/* ═══════════════════════════════════════════════
   STATE
═══════════════════════════════════════════════ */
const state = {
  chatId: null,
  chats: {},       // { id: { id, title, spaceId, messages:[], createdAt } }
  personas: [],    // { id, name, prompt }
  spaces: [],      // { id, name }
  artifacts: [],   // { id, lang, code, chatId, createdAt }
  vault: [],       // { id, title, text }
  activePersonaId: null,
  pendingImage: null, // { base64, name, dataUrl }
  isStreaming: false,
  recognition: null,
  micActive: false,
  canvasData: null,  // { code, lang, isHTML }
  confirmCb: null,
};

/* ═══════════════════════════════════════════════
   INIT — load from localStorage
═══════════════════════════════════════════════ */
function init() {
  state.chats = LS.get('aura:chats', {});
  state.personas = LS.get('aura:personas', []);
  state.spaces = LS.get('aura:spaces', []);
  state.artifacts = LS.get('aura:artifacts', []);
  state.vault = LS.get('aura:vault', []);
  state.activePersonaId = LS.get('aura:activePersona', null);

  // Load API key if saved
  const savedKey = LS.get('aura:apikey', '');
  if (savedKey) { document.getElementById('apikey-input').value = savedKey; document.getElementById('apikey-status').textContent = '✓ Key loaded'; }

  const chatIds = Object.keys(state.chats);
  if (chatIds.length > 0) {
    const lastId = LS.get('aura:lastChatId', chatIds[chatIds.length - 1]);
    loadChat(state.chats[lastId] ? lastId : chatIds[chatIds.length - 1]);
  } else {
    newChat();
  }
  renderChatHistory();
}

/* ═══════════════════════════════════════════════
   CHAT MANAGEMENT
═══════════════════════════════════════════════ */
function newChat() {
  const id = 'c_' + Date.now();
  state.chatId = id;
  state.chats[id] = { id, title: 'New Chat', spaceId: null, messages: [], createdAt: Date.now() };
  saveChats();
  renderChat();
  updateHeader();
  renderChatHistory();
  closeDrawer();
  LS.set('aura:lastChatId', id);
}

function loadChat(id) {
  if (!state.chats[id]) return;
  state.chatId = id;
  LS.set('aura:lastChatId', id);
  renderChat();
  updateHeader();
  closeDrawer();
}

function saveChats() { LS.set('aura:chats', state.chats); }

function currentChat() { return state.chats[state.chatId]; }

function updateHeader() {
  const chat = currentChat();
  if (!chat) return;
  document.getElementById('hdr-title').textContent = chat.title;
  const p = state.personas.find(p => p.id === state.activePersonaId);
  document.getElementById('hdr-subtitle').textContent = p ? `Persona: ${p.name}` : 'AURA AI';
}

function renderChatHistory() {
  const el = document.getElementById('chat-history-list');
  const chats = Object.values(state.chats).sort((a,b) => b.createdAt - a.createdAt).slice(0, 30);
  if (!chats.length) { el.innerHTML = '<div style="font-size:12px;color:var(--text-dim);padding:4px 10px;">No chats yet</div>'; return; }
  el.innerHTML = chats.map(c => {
    const space = c.spaceId ? state.spaces.find(s=>s.id===c.spaceId) : null;
    return `<div class="chat-history-item ${c.id===state.chatId?'active':''}" onclick="loadChat('${c.id}')">
      <i class="ph ph-chat-dots"></i>
      <span class="chi-title">${escHtml(c.title)}</span>
      ${space ? `<span class="chi-space-tag">${escHtml(space.name)}</span>` : ''}
      <i class="ph ph-x chi-delete" onclick="deleteChatConfirm('${c.id}',event)" title="Delete"></i>
    </div>`;
  }).join('');
}

function deleteChatConfirm(id, e) {
  e.stopPropagation();
  confirmAction('Delete Chat', 'This will permanently delete this chat. Continue?', () => {
    delete state.chats[id];
    saveChats();
    if (state.chatId === id) {
      const ids = Object.keys(state.chats);
      if (ids.length) loadChat(ids[ids.length-1]); else newChat();
    }
    renderChatHistory();
    toast('Chat deleted', 'success');
  });
}

/* ═══════════════════════════════════════════════
   RENDER CHAT
═══════════════════════════════════════════════ */
function renderChat() {
  const container = document.getElementById('messages-container');
  const empty = document.getElementById('empty-state');
  const chat = currentChat();
  if (!chat || !chat.messages.length) {
    container.innerHTML = '';
    empty.style.display = 'flex';
    return;
  }
  empty.style.display = 'none';
  container.innerHTML = chat.messages.map(m => renderMessage(m)).join('');
  attachCodeButtons();
  scrollBottom();
}

function renderMessage(msg) {
  const isUser = msg.role === 'user';
  const time = new Date(msg.ts).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
  let content = '';

  if (msg.imageDataUrl) {
    content += `<img src="${msg.imageDataUrl}" class="msg-image-thumb" alt="attached image">`;
  }

  if (isUser) {
    content += `<div>${escHtml(msg.content).replace(/\n/g,'<br>')}</div>`;
  } else {
    content += parseMarkdown(msg.content);
  }

  return `<div class="msg-group ${isUser?'user':'assistant'}">
    <div class="msg-avatar ${isUser?'user-av':'ai'}">${isUser?'U':'A'}</div>
    <div class="msg-bubble">${content}</div>
    <div class="msg-time">${time}</div>
  </div>`;
}

function appendMessage(msg) {
  const chat = currentChat(); if (!chat) return;
  chat.messages.push(msg);
  saveChats();

  const empty = document.getElementById('empty-state');
  empty.style.display = 'none';
  const container = document.getElementById('messages-container');
  const div = document.createElement('div');
  div.innerHTML = renderMessage(msg);
  container.appendChild(div.firstChild);
  attachCodeButtons();
  scrollBottom();

  // Auto-generate title from first user message
  if (chat.messages.length === 1 && msg.role === 'user') {
    chat.title = msg.content.slice(0, 42) + (msg.content.length > 42 ? '…' : '');
    saveChats();
    updateHeader();
    renderChatHistory();
  }
}

function scrollBottom() {
  const arena = document.getElementById('chat-arena');
  setTimeout(() => arena.scrollTop = arena.scrollHeight, 50);
}

/* ═══════════════════════════════════════════════
   MARKDOWN PARSER (lightweight)
═══════════════════════════════════════════════ */
function parseMarkdown(md) {
  if (!md) return '';
  const codeBlocks = [];
  // Extract code blocks
  let parsed = md.replace(/```(\w*)\n?([\s\S]*?)```/g, (_, lang, code) => {
    const idx = codeBlocks.length;
    codeBlocks.push({ lang: lang || 'text', code: code.trim() });
    return `%%CODEBLOCK_${idx}%%`;
  });

  // Inline
  parsed = parsed
    .replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')
    .replace(/\*(.+?)\*/g, '<em>$1</em>')
    .replace(/`([^`]+)`/g, '<code>$1</code>')
    .replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2" target="_blank" rel="noopener">$1</a>')
    .replace(/^#{3}\s+(.+)$/gm, '<h3>$1</h3>')
    .replace(/^#{2}\s+(.+)$/gm, '<h2>$1</h2>')
    .replace(/^#{1}\s+(.+)$/gm, '<h1>$1</h1>')
    .replace(/^\s*>\s+(.+)$/gm, '<blockquote>$1</blockquote>')
    .replace(/^---$/gm, '<hr>')
    .replace(/^\s*[-*]\s+(.+)$/gm, '<li>$1</li>')
    .replace(/(<li>[\s\S]*?<\/li>)/g, '<ul>$1</ul>')
    .replace(/<\/ul>\s*<ul>/g, '');

  // Paragraphs
  const lines = parsed.split('\n');
  let html = '';
  let inPara = false;
  for (const line of lines) {
    const stripped = line.trim();
    if (!stripped) { if (inPara) { html += '</p>'; inPara = false; } continue; }
    if (/^<(h[1-6]|ul|ol|li|blockquote|hr|pre)/.test(stripped) || stripped.startsWith('%%CODE')) {
      if (inPara) { html += '</p>'; inPara = false; }
      html += stripped;
    } else {
      if (!inPara) { html += '<p>'; inPara = true; }
      html += stripped + ' ';
    }
  }
  if (inPara) html += '</p>';

  // Restore code blocks
  html = html.replace(/%%CODEBLOCK_(\d+)%%/g, (_, idx) => {
    const {lang, code} = codeBlocks[parseInt(idx)];
    const isHTML = lang === 'html' || lang === 'HTML';
    return `<div class="code-wrapper">
      <div class="code-header">
        <span class="code-lang">${escHtml(lang)}</span>
        <div class="code-actions">
          <button class="code-action-btn" data-action="copy" data-code="${encodeURIComponent(code)}"><i class="ph ph-copy"></i> Copy</button>
          <button class="code-action-btn" data-action="canvas" data-lang="${escHtml(lang)}" data-ishtml="${isHTML}" data-code="${encodeURIComponent(code)}"><i class="ph ph-squares-four"></i> Canvas</button>
        </div>
      </div>
      <pre><code>${escHtml(code)}</code></pre>
    </div>`;
  });

  // Extract artifacts
  codeBlocks.forEach(({lang, code}) => {
    if (lang && lang !== 'text' && code.length > 20) {
      const artId = 'a_' + Date.now() + '_' + Math.random().toString(36).slice(2,6);
      state.artifacts.push({ id: artId, lang, code, chatId: state.chatId, createdAt: Date.now() });
    }
  });
  if (codeBlocks.length) LS.set('aura:artifacts', state.artifacts);

  return html;
}

/* ═══════════════════════════════════════════════
   CODE ACTION BUTTONS
═══════════════════════════════════════════════ */
function attachCodeButtons() {
  document.querySelectorAll('.code-action-btn[data-action="copy"]').forEach(btn => {
    btn.onclick = () => {
      navigator.clipboard.writeText(decodeURIComponent(btn.dataset.code));
      toast('Copied!', 'success');
    };
  });
  document.querySelectorAll('.code-action-btn[data-action="canvas"]').forEach(btn => {
    btn.onclick = () => openCanvas(decodeURIComponent(btn.dataset.code), btn.dataset.lang, btn.dataset.ishtml === 'true');
  });
}

/* ═══════════════════════════════════════════════
   SEND MESSAGE
═══════════════════════════════════════════════ */
async function sendMessage(text) {
  const chat = currentChat(); if (!chat) return;
  if (state.isStreaming) return;
  text = text.trim(); if (!text && !state.pendingImage) return;

  const userMsg = { role: 'user', content: text, ts: Date.now() };
  if (state.pendingImage) {
    userMsg.imageBase64 = state.pendingImage.base64;
    userMsg.imageDataUrl = state.pendingImage.dataUrl;
    clearImage();
  }
  appendMessage(userMsg);

  // Show typing indicator
  const typingId = showTyping();
  state.isStreaming = true;
  document.getElementById('send-btn').disabled = true;

  const messages = chat.messages.slice(0, -1).map(m => ({
    role: m.role, content: m.content
  }));

  try {
    const persona = state.personas.find(p => p.id === state.activePersonaId);
    const systemPrompt = persona ? persona.prompt : 'You are AURA, a helpful, intelligent AI assistant.';
    const responseText = await fetchAPI(messages, text, userMsg.imageBase64 || null, systemPrompt);
    removeTyping(typingId);
    appendMessage({ role: 'assistant', content: responseText, ts: Date.now() });
  } catch (err) {
    removeTyping(typingId);
    appendMessage({ role: 'assistant', content: `⚠️ Error: ${err.message}`, ts: Date.now() });
    toast('API error: ' + err.message, 'error');
  } finally {
    state.isStreaming = false;
    document.getElementById('send-btn').disabled = false;
  }
}

/* ═══════════════════════════════════════════════
   API CALL (plug in your endpoint)
═══════════════════════════════════════════════ */
async function fetchAPI(history, newUserText, imageBase64, systemPrompt) {
  const apiKey = LS.get('aura:apikey', '');
  if (!apiKey) {
    throw new Error('No API key saved. Tap the 🔑 icon to add one.');
  }

  /* ─────────────────────────────────────────────
     TODO: Replace these with your actual endpoint, model, and request shape.
     Below is a Gemini-style structure. For OpenAI-compatible APIs, swap accordingly.
  ───────────────────────────────────────────── */
  const API_URL = 'https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent';
  // const API_URL = 'https://api.openai.com/v1/chat/completions'; // OpenAI example

  // Build content parts
  const parts = [{ text: newUserText || '' }];
  if (imageBase64) {
    // Extract mime type from base64 header if present
    let mimeType = 'image/jpeg';
    let data = imageBase64;
    const match = imageBase64.match(/^data:(image\/[^;]+);base64,(.+)/);
    if (match) { mimeType = match[1]; data = match[2]; }
    parts.push({ inlineData: { mimeType, data } });
  }

  const contents = [
    ...history.map(m => ({ role: m.role === 'assistant' ? 'model' : 'user', parts: [{ text: m.content }] })),
    { role: 'user', parts }
  ];

  const body = {
    systemInstruction: { parts: [{ text: systemPrompt }] },
    contents,
    generationConfig: { temperature: 0.9, maxOutputTokens: 4096 }
  };

  // ── Streaming (Gemini) ──
  const res = await fetch(`${API_URL}?key=${apiKey}&alt=sse`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(body)
  });

  if (!res.ok) {
    const err = await res.json().catch(() => ({}));
    throw new Error(err?.error?.message || `HTTP ${res.status}`);
  }

  // Handle streaming SSE
  const reader = res.body?.getReader();
  if (!reader) throw new Error('No response body');

  const decoder = new TextDecoder();
  let fullText = '';
  let buffer = '';

  // Insert live-streaming placeholder
  const chat = currentChat();
  const streamMsg = { role: 'assistant', content: '', ts: Date.now(), _streaming: true };
  chat.messages.push(streamMsg);
  const empty = document.getElementById('empty-state'); empty.style.display = 'none';
  const container = document.getElementById('messages-container');
  const streamEl = document.createElement('div');
  streamEl.className = 'msg-group assistant';
  streamEl.innerHTML = `<div class="msg-avatar ai">A</div><div class="msg-bubble stream-bubble"></div><div class="msg-time"></div>`;
  container.appendChild(streamEl);
  const bubbleEl = streamEl.querySelector('.stream-bubble');

  while (true) {
    const {done, value} = await reader.read();
    if (done) break;
    buffer += decoder.decode(value, {stream: true});
    const lines = buffer.split('\n');
    buffer = lines.pop();
    for (const line of lines) {
      if (!line.startsWith('data: ')) continue;
      const raw = line.slice(6).trim();
      if (raw === '[DONE]') continue;
      try {
        const j = JSON.parse(raw);
        const chunk = j?.candidates?.[0]?.content?.parts?.[0]?.text || '';
        fullText += chunk;
        bubbleEl.innerHTML = parseMarkdown(fullText);
        attachCodeButtons();
        scrollBottom();
      } catch {}
    }
  }

  // Finalize
  streamEl.remove();
  chat.messages.pop(); // remove placeholder
  return fullText || '(empty response)';
}

/* ═══════════════════════════════════════════════
   TYPING INDICATOR
═══════════════════════════════════════════════ */
let typingCounter = 0;
function showTyping() {
  const id = 'typing_' + typingCounter++;
  const container = document.getElementById('messages-container');
  const div = document.createElement('div');
  div.className = 'msg-group assistant'; div.id = id;
  div.innerHTML = `<div class="msg-avatar ai">A</div><div class="msg-bubble"><div class="typing-indicator"><div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div></div></div>`;
  container.appendChild(div);
  scrollBottom();
  return id;
}
function removeTyping(id) {
  const el = document.getElementById(id); if (el) el.remove();
}

/* ═══════════════════════════════════════════════
   IMAGE HANDLING
═══════════════════════════════════════════════ */
function handleImageFile(file) {
  if (!file || !file.type.startsWith('image/')) { toast('Please select an image', 'error'); return; }
  const reader = new FileReader();
  reader.onload = (e) => {
    const dataUrl = e.target.result;
    const base64 = dataUrl; // keep full data URL — we strip in fetchAPI
    state.pendingImage = { base64, dataUrl, name: file.name };
    document.getElementById('img-thumb').src = dataUrl;
    document.getElementById('img-name').textContent = file.name;
    document.getElementById('image-preview-area').classList.add('visible');
    toast('Image attached', 'success');
  };
  reader.readAsDataURL(file);
}
function clearImage() {
  state.pendingImage = null;
  document.getElementById('image-preview-area').classList.remove('visible');
  document.getElementById('file-input').value = '';
}

/* ═══════════════════════════════════════════════
   CANVAS
═══════════════════════════════════════════════ */
function openCanvas(code, lang, isHTML) {
  state.canvasData = { code, lang, isHTML };
  document.getElementById('canvas-title').textContent = lang || 'code';
  document.getElementById('canvas-code-el').textContent = code;
  document.getElementById('canvas-overlay').classList.add('open');
  switchCanvasView('code');
}
function closeCanvas() { document.getElementById('canvas-overlay').classList.remove('open'); }

function switchCanvasView(view) {
  const codeView = document.getElementById('canvas-code-view');
  const preview = document.getElementById('canvas-preview');
  const textView = document.getElementById('canvas-text-view');
  codeView.style.display = 'none'; preview.style.display = 'none'; textView.style.display = 'none';
  document.querySelectorAll('.canvas-tab').forEach(t => t.classList.remove('active'));
  document.querySelector(`.canvas-tab[data-view="${view}"]`)?.classList.add('active');

  if (view === 'code') codeView.style.display = 'block';
  else if (view === 'preview') {
    preview.style.display = 'block';
    if (state.canvasData?.isHTML) {
      const iframe = document.getElementById('canvas-iframe');
      iframe.srcdoc = state.canvasData.code;
    } else {
      preview.innerHTML = `<div style="padding:20px;color:var(--text-muted);font-size:13px;">Preview only available for HTML code blocks.</div>`;
    }
  } else {
    textView.style.display = 'block';
    textView.innerHTML = parseMarkdown(state.canvasData?.code || '');
  }
}

/* ═══════════════════════════════════════════════
   PERSONAS
═══════════════════════════════════════════════ */
function savePersona() {
  const name = document.getElementById('persona-name').value.trim();
  const prompt = document.getElementById('persona-prompt').value.trim();
  if (!name || !prompt) { toast('Name and prompt required', 'error'); return; }
  const id = 'p_' + Date.now();
  state.personas.push({ id, name, prompt });
  LS.set('aura:personas', state.personas);
  document.getElementById('persona-name').value = '';
  document.getElementById('persona-prompt').value = '';
  renderPersonasList();
  toast(`Persona "${name}" saved`, 'success');
}
function renderPersonasList() {
  const el = document.getElementById('personas-list');
  if (!state.personas.length) { el.innerHTML = '<div class="empty-list"><i class="ph ph-mask-happy"></i>No personas yet</div>'; return; }
  el.innerHTML = state.personas.map(p => `
    <div class="item-card ${state.activePersonaId===p.id?'selected':''}" onclick="selectPersona('${p.id}')">
      <div class="item-card-icon"><i class="ph ph-mask-happy"></i></div>
      <div class="item-card-body">
        <div class="item-card-title">${escHtml(p.name)}</div>
        <div class="item-card-sub">${escHtml(p.prompt)}</div>
      </div>
      <div class="item-card-actions">
        <button class="item-action del" onclick="deletePersona('${p.id}',event)">Del</button>
      </div>
    </div>`).join('');
}
function selectPersona(id) {
  state.activePersonaId = state.activePersonaId === id ? null : id;
  LS.set('aura:activePersona', state.activePersonaId);
  renderPersonasList();
  updateHeader();
  toast(state.activePersonaId ? 'Persona activated' : 'Persona cleared', 'success');
}
function deletePersona(id, e) {
  e.stopPropagation();
  state.personas = state.personas.filter(p => p.id !== id);
  if (state.activePersonaId === id) { state.activePersonaId = null; LS.set('aura:activePersona', null); }
  LS.set('aura:personas', state.personas);
  renderPersonasList(); updateHeader();
  toast('Persona deleted', 'success');
}

/* ═══════════════════════════════════════════════
   SPACES
═══════════════════════════════════════════════ */
function saveSpace() {
  const name = document.getElementById('space-name').value.trim();
  if (!name) { toast('Space name required', 'error'); return; }
  const id = 'sp_' + Date.now();
  state.spaces.push({ id, name });
  LS.set('aura:spaces', state.spaces);
  document.getElementById('space-name').value = '';
  renderSpacesList();
  renderChatHistory();
  toast(`Space "${name}" created`, 'success');
}
function renderSpacesList() {
  const el = document.getElementById('spaces-list');
  if (!state.spaces.length) { el.innerHTML = '<div class="empty-list"><i class="ph ph-folder-open"></i>No spaces yet</div>'; }
  else el.innerHTML = state.spaces.map(s => `
    <div class="item-card">
      <div class="item-card-icon"><i class="ph ph-folder-open"></i></div>
      <div class="item-card-body">
        <div class="item-card-title">${escHtml(s.name)}</div>
        <div class="item-card-sub">${Object.values(state.chats).filter(c=>c.spaceId===s.id).length} chats</div>
      </div>
      <div class="item-card-actions">
        <button class="item-action del" onclick="deleteSpace('${s.id}')">Del</button>
      </div>
    </div>`).join('');

  // Assign area
  const assign = document.getElementById('assign-spaces-list');
  const chat = currentChat();
  if (state.spaces.length && chat) {
    assign.innerHTML = state.spaces.map(s => `
      <span class="space-chip ${chat.spaceId===s.id?'selected':''}" onclick="assignSpace('${s.id}')">
        <i class="ph ph-folder-open"></i> ${escHtml(s.name)}
      </span>`).join('');
  } else {
    assign.innerHTML = '<div style="font-size:13px;color:var(--text-dim);">Create a space first</div>';
  }
}
function assignSpace(id) {
  const chat = currentChat(); if (!chat) return;
  chat.spaceId = chat.spaceId === id ? null : id;
  saveChats(); renderSpacesList(); renderChatHistory();
  toast('Chat assigned', 'success');
}
function deleteSpace(id) {
  state.spaces = state.spaces.filter(s => s.id !== id);
  Object.values(state.chats).forEach(c => { if (c.spaceId === id) c.spaceId = null; });
  LS.set('aura:spaces', state.spaces); saveChats();
  renderSpacesList(); renderChatHistory();
  toast('Space deleted', 'success');
}

/* ═══════════════════════════════════════════════
   ARTIFACTS
═══════════════════════════════════════════════ */
function renderArtifactsList() {
  const el = document.getElementById('artifacts-list');
  if (!state.artifacts.length) { el.innerHTML = '<div class="empty-list"><i class="ph ph-atom"></i>No artifacts yet. Code blocks from AI responses appear here.</div>'; return; }
  // Deduplicate by code content
  const seen = new Set();
  const unique = state.artifacts.filter(a => { if (seen.has(a.code)) return false; seen.add(a.code); return true; });
  el.innerHTML = unique.slice(0, 50).map(a => `
    <div class="artifact-thumb" onclick='openArtifactCanvas(${JSON.stringify(a)})'>
      <div class="artifact-header">
        <span class="artifact-lang">${escHtml(a.lang)}</span>
        <span class="artifact-date">${new Date(a.createdAt).toLocaleDateString()}</span>
      </div>
      <div class="artifact-preview">${escHtml(a.code)}</div>
    </div>`).join('');
}
function openArtifactCanvas(a) {
  closeModal('artifacts-modal');
  setTimeout(() => openCanvas(a.code, a.lang, a.lang === 'html'), 300);
}

/* ═══════════════════════════════════════════════
   PROMPT VAULT
═══════════════════════════════════════════════ */
function saveVaultSnippet() {
  const title = document.getElementById('vault-title').value.trim();
  const text = document.getElementById('vault-text').value.trim();
  if (!title || !text) { toast('Title and text required', 'error'); return; }
  const id = 'v_' + Date.now();
  state.vault.push({ id, title, text });
  LS.set('aura:vault', state.vault);
  document.getElementById('vault-title').value = '';
  document.getElementById('vault-text').value = '';
  renderVaultList();
  toast(`Snippet "${title}" saved`, 'success');
}
function renderVaultList() {
  const el = document.getElementById('vault-list');
  if (!state.vault.length) { el.innerHTML = '<div class="empty-list"><i class="ph ph-lightning"></i>No snippets yet</div>'; return; }
  el.innerHTML = state.vault.map(v => `
    <div class="vault-item">
      <div class="vault-item-content">
        <div class="vault-item-title">${escHtml(v.title)}</div>
        <div class="vault-item-text">${escHtml(v.text)}</div>
      </div>
      <div class="vault-item-actions">
        <button class="item-action" onclick="useVaultSnippet('${v.id}')">Use</button>
        <button class="item-action del" onclick="deleteVaultSnippet('${v.id}')">Del</button>
      </div>
    </div>`).join('');
}
function useVaultSnippet(id) {
  const v = state.vault.find(v => v.id === id); if (!v) return;
  document.getElementById('msg-input').value = v.text;
  autoGrow(document.getElementById('msg-input'));
  closeModal('vault-modal');
  document.getElementById('msg-input').focus();
  toast(`Snippet loaded`, 'success');
}
function deleteVaultSnippet(id) {
  state.vault = state.vault.filter(v => v.id !== id);
  LS.set('aura:vault', state.vault);
  renderVaultList();
  toast('Snippet deleted', 'success');
}

/* ═══════════════════════════════════════════════
   EXPORT BACKUP
═══════════════════════════════════════════════ */
function exportBackup() {
  const data = {
    _export: { date: new Date().toISOString(), app: 'AURA' },
    chats: state.chats,
    personas: state.personas,
    spaces: state.spaces,
    artifacts: state.artifacts,
    vault: state.vault,
  };
  const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = `aura-backup-${Date.now()}.json`;
  document.body.appendChild(a); a.click();
  document.body.removeChild(a); URL.revokeObjectURL(url);
  toast('Backup downloaded!', 'success');
  closeDrawer();
}

/* ═══════════════════════════════════════════════
   VOICE TO TEXT
═══════════════════════════════════════════════ */
function toggleMic() {
  const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
  if (!SpeechRecognition) { toast('Speech recognition not supported in this browser', 'error'); return; }

  if (state.micActive) {
    state.recognition?.stop();
    state.micActive = false;
    document.getElementById('mic-btn').classList.remove('active');
    document.getElementById('mic-indicator').classList.remove('active');
    return;
  }

  const rec = new SpeechRecognition();
  rec.continuous = true; rec.interimResults = true; rec.lang = 'en-US';
  state.recognition = rec;

  rec.onstart = () => {
    state.micActive = true;
    document.getElementById('mic-btn').classList.add('active');
    document.getElementById('mic-indicator').classList.add('active');
  };
  rec.onresult = (e) => {
    let final = '', interim = '';
    for (let i = e.resultIndex; i < e.results.length; i++) {
      if (e.results[i].isFinal) final += e.results[i][0].transcript;
      else interim += e.results[i][0].transcript;
    }
    const input = document.getElementById('msg-input');
    input.value = (input.value + final).trim();
    if (interim) input.value = input.value + ' ' + interim;
    autoGrow(input);
  };
  rec.onerror = (e) => { toast('Mic error: ' + e.error, 'error'); state.micActive = false; document.getElementById('mic-btn').classList.remove('active'); document.getElementById('mic-indicator').classList.remove('active'); };
  rec.onend = () => {
    state.micActive = false;
    document.getElementById('mic-btn').classList.remove('active');
    document.getElementById('mic-indicator').classList.remove('active');
  };
  rec.start();
}

/* ═══════════════════════════════════════════════
   MODAL / DRAWER HELPERS
═══════════════════════════════════════════════ */
function openModal(id) {
  document.getElementById(id)?.classList.add('open');
  // Lazy render
  if (id === 'personas-modal') renderPersonasList();
  if (id === 'spaces-modal') renderSpacesList();
  if (id === 'artifacts-modal') renderArtifactsList();
  if (id === 'vault-modal') renderVaultList();
}
function closeModal(id) { document.getElementById(id)?.classList.remove('open'); }

function openDrawer() {
  document.getElementById('drawer').classList.add('open');
  document.getElementById('drawer-overlay').classList.add('open');
  renderChatHistory();
}
function closeDrawer() {
  document.getElementById('drawer').classList.remove('open');
  document.getElementById('drawer-overlay').classList.remove('open');
}

function confirmAction(title, message, cb) {
  document.getElementById('confirm-title').textContent = title;
  document.getElementById('confirm-message').textContent = message;
  state.confirmCb = cb;
  openModal('confirm-modal');
}

/* ═══════════════════════════════════════════════
   TOAST
═══════════════════════════════════════════════ */
function toast(msg, type = 'success') {
  const icon = type === 'success' ? 'ph-check-circle' : 'ph-warning-circle';
  const el = document.createElement('div');
  el.className = `toast ${type}`;
  el.innerHTML = `<i class="ph ${icon}"></i>${msg}`;
  document.getElementById('toast-container').appendChild(el);
  setTimeout(() => el.remove(), 3000);
}

/* ═══════════════════════════════════════════════
   UTILS
═══════════════════════════════════════════════ */
function escHtml(s) {
  return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

function autoGrow(el) {
  el.style.height = 'auto';
  el.style.height = Math.min(el.scrollHeight, 140) + 'px';
}

/* ═══════════════════════════════════════════════
   EVENT LISTENERS
═══════════════════════════════════════════════ */
// Hamburger
document.getElementById('hamburger-btn').addEventListener('click', () => {
  document.getElementById('drawer').classList.contains('open') ? closeDrawer() : openDrawer();
});
document.getElementById('drawer-overlay').addEventListener('click', closeDrawer);

// New chat
document.getElementById('new-chat-btn').addEventListener('click', newChat);

// Drawer nav items
document.querySelectorAll('.nav-item[data-modal]').forEach(item => {
  item.addEventListener('click', () => {
    closeDrawer();
    setTimeout(() => openModal(item.dataset.modal + '-modal'), 200);
  });
});

// Modal close buttons
document.querySelectorAll('[data-close]').forEach(btn => {
  btn.addEventListener('click', () => closeModal(btn.dataset.close));
});
document.querySelectorAll('.modal-backdrop').forEach(bd => {
  bd.addEventListener('click', (e) => { if (e.target === bd) bd.classList.remove('open'); });
});

// API key
document.getElementById('apikey-btn').addEventListener('click', () => {
  document.getElementById('apikey-panel').classList.toggle('open');
});
document.getElementById('apikey-save').addEventListener('click', () => {
  const val = document.getElementById('apikey-input').value.trim();
  if (!val) { toast('Enter an API key', 'error'); return; }
  LS.set('aura:apikey', val);
  document.getElementById('apikey-status').textContent = '✓ Saved!';
  setTimeout(() => { document.getElementById('apikey-panel').classList.remove('open'); }, 800);
  toast('API key saved', 'success');
});

// Clear chat
document.getElementById('clear-btn').addEventListener('click', () => {
  confirmAction('Clear Chat', 'This will delete all messages in the current chat. Continue?', () => {
    const chat = currentChat(); if (!chat) return;
    chat.messages = [];
    saveChats(); renderChat(); renderChatHistory();
    toast('Chat cleared', 'success');
  });
});

// Send button
document.getElementById('send-btn').addEventListener('click', () => {
  const input = document.getElementById('msg-input');
  const text = input.value;
  input.value = ''; autoGrow(input);
  sendMessage(text);
});

// Enter to send (shift+enter = newline)
document.getElementById('msg-input').addEventListener('keydown', (e) => {
  if (e.key === 'Enter' && !e.shiftKey) {
    e.preventDefault();
    const input = e.target;
    const text = input.value;
    input.value = ''; autoGrow(input);
    sendMessage(text);
  }
});
document.getElementById('msg-input').addEventListener('input', (e) => autoGrow(e.target));

// Camera / image
document.getElementById('camera-btn').addEventListener('click', () => document.getElementById('file-input').click());
document.getElementById('file-input').addEventListener('change', (e) => handleImageFile(e.target.files[0]));
document.getElementById('img-remove').addEventListener('click', clearImage);

// Mic
document.getElementById('mic-btn').addEventListener('click', toggleMic);

// Canvas
document.getElementById('canvas-close-btn').addEventListener('click', closeCanvas);
document.querySelectorAll('.canvas-tab').forEach(tab => {
  tab.addEventListener('click', () => switchCanvasView(tab.dataset.view));
});
document.getElementById('canvas-copy-btn').addEventListener('click', () => {
  if (state.canvasData) {
    navigator.clipboard.writeText(state.canvasData.code);
    toast('Copied!', 'success');
  }
});

// Personas
document.getElementById('save-persona-btn').addEventListener('click', savePersona);

// Spaces
document.getElementById('save-space-btn').addEventListener('click', saveSpace);

// Vault
document.getElementById('save-vault-btn').addEventListener('click', saveVaultSnippet);

// Export
document.getElementById('export-btn').addEventListener('click', exportBackup);

// Confirm
document.getElementById('confirm-ok-btn').addEventListener('click', () => {
  if (state.confirmCb) { state.confirmCb(); state.confirmCb = null; }
  closeModal('confirm-modal');
});

// Starter chips
document.querySelectorAll('.chip').forEach(chip => {
  chip.addEventListener('click', () => {
    const prompt = chip.dataset.prompt;
    document.getElementById('msg-input').value = prompt;
    autoGrow(document.getElementById('msg-input'));
    document.getElementById('msg-input').focus();
  });
});

// Close API panel when clicking outside
document.addEventListener('click', (e) => {
  const panel = document.getElementById('apikey-panel');
  const btn = document.getElementById('apikey-btn');
  if (panel.classList.contains('open') && !panel.contains(e.target) && !btn.contains(e.target)) {
    panel.classList.remove('open');
  }
});

// Swipe to close drawer
let touchStartX = 0;
document.addEventListener('touchstart', (e) => { touchStartX = e.touches[0].clientX; }, {passive:true});
document.addEventListener('touchend', (e) => {
  const dx = e.changedTouches[0].clientX - touchStartX;
  if (dx < -60 && document.getElementById('drawer').classList.contains('open')) closeDrawer();
});

/* ═══════════════════════════════════════════════
   BOOT
═══════════════════════════════════════════════ */
init();
</script>
</body>
</html>
